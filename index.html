<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Krizmanici s Kne≈æije</title>

  <link rel="stylesheet" href="style.css" />
</head>

<body>
  <header>
    <div class="wrap">
      <h2 style="margin:0;">Krizmanici s Kne≈æije</h2>
      <small>Nismo stvoreni da dimimo, nego da gorimo üî•</small>
    </div>
  </header>

  <div class="wrap">
    <div class="row">
      <div class="tabs">
        <button class="tabbtn active" data-tab="ann">
          üì¢ Obavijesti
          <span id="newBadge" class="badge" style="display:none;margin-left:6px;">NEW</span>
        </button>
        <button class="tabbtn" data-tab="kateheze">üìñ Kateheze po tjednima</button>
        <button class="tabbtn" data-tab="jokes">Po‚òï</button>
        <button class="tabbtn" data-tab="faq">‚ùì (ne)Zanimljiva pitanja</button>
      </div>

      <div class="row" style="gap:10px;">
        <button class="btn" id="refreshBtn">‚Üª Refresh</button>
        <!-- <a class="btn" href="https://t.me/yourgroup" target="_blank" rel="noreferrer">Join Telegram</a> -->
      </div>
    </div>

    <!-- ANNOUNCEMENTS -->
    <section id="tab-ann" class="card">
      <div class="row">
        <div>
          <b>Obavijesti</b><br/>
        </div>
        <div class="muted" id="lastCheck"></div>
      </div>
      <div id="annList" style="margin-top:12px;"></div>
    </section>

    <!-- KATEHEZE -->
    <section id="tab-kateheze" class="card" style="display:none;">
      <div class="row">
        <div>
          <b>Kateheze</b><br/>
        </div>
      </div>

      <div id="katehezeList" style="margin-top:12px;"></div>
    </section>

    <!-- JOKES -->
    <section id="tab-jokes" class="card" style="display:none;">
      <div class="row">
        <div>
          <b>Po‚òï</b><br/>
        </div>
        <button class="btn" id="randomJokeBtn">üé≤ Random</button>
      </div>
      <div id="jokeBox" class="post" style="margin-top:12px;"></div>
      <div id="jokesList" style="margin-top:12px;"></div>
    </section>

    <!-- FAQ -->
    <section id="tab-faq" class="card" style="display:none;">
      <div class="row">
        <div>
          <b>Pitanja i odgovori</b><br/>
        </div>
        <input id="faqSearch" placeholder="Search..." />
      </div>
      <div id="faqList" style="margin-top:12px;"></div>
    </section>
  </div>

  <!-- LESSON MODAL (popup) -->
  <div id="lessonModal" class="modal" style="display:none;">
    <div class="modalBox">
      <div class="modalHeader">
        <div>
          <div id="modalTitle" class="modalTitle">Kateheza</div>
          <div id="modalMeta" class="modalMeta"></div>
        </div>
        <button class="btn" id="modalCloseBtn">‚úñ</button>
      </div>

      <div id="modalBody" class="modalBody"></div>
    </div>
  </div>

  <script>
    // Tabs
    const tabs = document.querySelectorAll(".tabbtn");
    const sections = {
      ann: "tab-ann",
      kateheze: "tab-kateheze",
      jokes: "tab-jokes",
      faq: "tab-faq"
    };

    tabs.forEach(btn => btn.addEventListener("click", () => {
      tabs.forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
      Object.values(sections).forEach(id => document.getElementById(id).style.display = "none");
      document.getElementById(sections[btn.dataset.tab]).style.display = "block";

      if (btn.dataset.tab === "ann") markAnnouncementsSeen();
    }));

    // Data
    const state = {
      announcements: [],
      kateheze: [],
      jokes: [],
      faq: []
    };

    function nowStamp() {
      return new Date().toLocaleString();
    }

    async function loadJSON(path) {
      const res = await fetch(`${path}?v=${Date.now()}`); // cache-bust
      if (!res.ok) throw new Error(`Failed to load ${path}`);
      return await res.json();
    }

    // Render announcements
    function renderAnnouncements() {
      const el = document.getElementById("annList");
      el.innerHTML = "";

      const items = state.announcements.slice().sort((a,b)=> (b.date||"").localeCompare(a.date||""));

      items.forEach((p) => {
        const div = document.createElement("div");
        div.className = "post";
        div.innerHTML = `
          <h3>${p.title || "Obavijest"}</h3>
          <div class="meta">${p.date || ""} ${p.tag ? `‚Ä¢ <span class="badge">${p.tag}</span>` : ""}</div>
          <p style="margin:10px 0 0;">${(p.text || "").replaceAll("\n","<br/>")}</p>
        `;
        el.appendChild(div);
      });

      const latest = items[0]?.date || "";
      const lastSeen = localStorage.getItem("lastSeenAnnouncement") || "";
      const badge = document.getElementById("newBadge");
      badge.style.display = (latest && latest !== lastSeen) ? "inline-block" : "none";
    }

    function markAnnouncementsSeen() {
      const items = state.announcements.slice().sort((a,b)=> (b.date||"").localeCompare(a.date||""));
      const latest = items[0]?.date || "";
      if (latest) localStorage.setItem("lastSeenAnnouncement", latest);
      const badge = document.getElementById("newBadge");
      if (badge) badge.style.display = "none";
    }

    // === Kateheze as clickable cards ===
    function renderKateheze() {
      const list = document.getElementById("katehezeList");
      list.innerHTML = "";

      const items = state.kateheze
        .slice()
        .sort((a,b)=> (b.date||"").localeCompare(a.date||""));

      items.forEach(lesson => {
        const card = document.createElement("div");
        card.className = "kCard";
        card.tabIndex = 0;

        card.innerHTML = `
          <div class="kCardTop">
            <div class="kCardTitle">üìñ ${lesson.title || "Kateheza"}</div>
            <div class="kCardDate">${lesson.date || ""}</div>
          </div>
          <div class="kCardPreview">${lesson.preview || "Klikni da otvori≈° katehezu."}</div>
          <div class="kCardEnter">Uƒëi ‚Üí</div>
        `;

        // You MUST have lesson.id in kateheze.json
        card.addEventListener("click", () => openLesson(lesson.id));
        card.addEventListener("keypress", (e) => {
          if (e.key === "Enter") openLesson(lesson.id);
        });

        list.appendChild(card);
      });
    }

    function openLesson(id) {
      const lesson = state.kateheze.find(x => x.id === id);
      if (!lesson) {
        alert("Missing lesson id. Add 'id' to each object in kateheze.json (e.g. k1, k2, k3).");
        return;
      }

      document.getElementById("modalTitle").textContent = `üìñ ${lesson.title || "Kateheza"}`;
      document.getElementById("modalMeta").textContent = lesson.date || "";
      document.getElementById("modalBody").innerHTML =
        (lesson.text || "").replaceAll("\n", "<br/>");

      document.getElementById("lessonModal").style.display = "flex";
      location.hash = `kateheza-${id}`;
    }

    function closeLesson() {
      document.getElementById("lessonModal").style.display = "none";
      if (location.hash.startsWith("#kateheza-")) history.replaceState(null, "", " ");
    }

    // Render jokes
    function renderJokes() {
      const list = document.getElementById("jokesList");
      list.innerHTML = "";
      state.jokes.forEach(j => {
        const div = document.createElement("div");
        div.className = "post";
        div.innerHTML = `<b>${j.title || "Po‚òï"}</b><p style="margin:8px 0 0;">${(j.text||"").replaceAll("\n","<br/>")}</p>`;
        list.appendChild(div);
      });
    }

    function randomJoke() {
      if (!state.jokes.length) return;
      const j = state.jokes[Math.floor(Math.random() * state.jokes.length)];
      document.getElementById("jokeBox").innerHTML =
        `<b>${j.title || "Random"}</b><p style="margin:8px 0 0;">${(j.text||"").replaceAll("\n","<br/>")}</p>`;
    }

    // Render FAQ
    function renderFAQ(filter="") {
      const list = document.getElementById("faqList");
      list.innerHTML = "";
      const f = filter.trim().toLowerCase();

      state.faq
        .filter(x => !f || (x.q||"").toLowerCase().includes(f) || (x.a||"").toLowerCase().includes(f))
        .forEach(item => {
          const d = document.createElement("details");
          d.innerHTML = `<summary>${item.q || "Pitanje"}</summary><div style="margin-top:8px;" class="muted">${(item.a||"").replaceAll("\n","<br/>")}</div>`;
          list.appendChild(d);
        });
    }

    // Refresh all data
    async function refreshAll() {
      const lastCheck = document.getElementById("lastCheck");
      lastCheck.textContent = "Checking...";
      try {
        state.announcements = await loadJSON("announcements.json");
        state.kateheze = await loadJSON("kateheze.json");
        state.jokes = await loadJSON("jokes.json");
        state.faq = await loadJSON("faq.json");

        renderAnnouncements();
        renderKateheze();
        renderJokes();
        renderFAQ(document.getElementById("faqSearch").value);

        lastCheck.textContent = `Last check: ${nowStamp()}`;

        // Open lesson directly if URL has hash like #kateheza-k2
        if (location.hash.startsWith("#kateheza-")) {
          const id = location.hash.replace("#kateheza-", "");
          openLesson(id);
        }
      } catch (e) {
        lastCheck.textContent = "Error loading content.";
        alert(e.message);
      }
    }

    // Events
    document.getElementById("refreshBtn").addEventListener("click", refreshAll);

    const randomBtn = document.getElementById("randomJokeBtn");
    if (randomBtn) randomBtn.addEventListener("click", randomJoke);

    document.getElementById("faqSearch").addEventListener("input", (e)=> renderFAQ(e.target.value));

    document.getElementById("modalCloseBtn").addEventListener("click", closeLesson);

    document.getElementById("lessonModal").addEventListener("click", (e) => {
      if (e.target.id === "lessonModal") closeLesson();
    });

    window.addEventListener("hashchange", () => {
      if (location.hash.startsWith("#kateheza-")) {
        const id = location.hash.replace("#kateheza-", "");
        openLesson(id);
      }
    });

    // Init
    refreshAll();
  </script>
</body>
</html>
